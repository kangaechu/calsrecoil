# calsrecoil

Googleカレンダーの予定を自動で処理し、記録タグを付与する自動化ツール

---

## 概要

**calsrecoil**は、Googleカレンダー上の特定条件のイベントを自動で検出し、
指定したシェルスクリプトを並行実行、その結果をイベントのタイトルに
`🆗`または`🆖`タグとして自動追記するGo製ツールです。

- サービスアカウント認証方式対応
- 終了時間を過ぎた予定で、タイトルに`🆗`や`🆖`が含まれていないイベントが対象
- イベントごとにシェルスクリプト（`calsrecoil.sh`）を自動実行（並行実行対応）
- 正常終了した場合は`🆗`、失敗した場合は`🆖`を自動付与
- `🆖`は最大5回まで付与（リトライ上限）
- Googleカレンダーの予定編集にも自動対応
- 環境変数でカレンダーIDや待機時間などを指定可能

---

## 必要条件

- Go 1.20 以降
- Google Cloud Consoleで「サービスアカウント」作成
- サービスアカウント用JSONキー（例：`service-account.json`）
- サービスアカウントを対象カレンダーに「編集者」として共有済み
- シェルスクリプト（`calsrecoil.sh`）のパス指定
- カレンダーID

---

## サービスアカウントの設定手順

1. **Google Cloud Consoleでプロジェクト作成**
2. **サービスアカウント作成**
   - [IAMと管理] → [サービスアカウント] → 新規作成
   - 「キー」タブからJSONキーを生成・ダウンロード（例：`service-account.json`）
3. **対象のGoogleカレンダーを開き、「設定と共有」→「特定のユーザーと共有」で**
   - サービスアカウントのメールアドレスを「編集者」として追加

---

## セットアップ

1. **このリポジトリをクローン**

    ```sh
    git clone https://github.com/your-account/calsrecoil.git
    cd calsrecoil
    ```

2. **依存パッケージのインストール**

    ```sh
    go mod tidy
    ```

3. **`service-account.json` をプロジェクトディレクトリに配置**

4. **環境変数を設定**
   - `CALENDAR_ID`：対象カレンダーのID
   - `RUN_AFTER_MINUTES`：終了後何分経過したイベントを対象にするか（省略時0）

5. **必要に応じて`main.go`内の定数を編集**
   - `scriptFile`：実行するシェルスクリプト名（デフォルト: `calsrecoil.sh`）
   - `timeZone`：タイムゾーン（デフォルト: `Asia/Tokyo`）

---

## 使い方

```sh
go run main.go
```

### 実行時の動作
- 直近1週間のイベントを取得し、終了済みかつ未処理（`🆗`/`🆖`なし）のものを抽出
- 各イベントごとに `calsrecoil.sh` を以下の引数で実行：
  1. 開始日時
  2. 終了日時
  3. タイトル（タグ除去済み）
  4. 場所
  5. 説明
- シェルスクリプトの終了コードでタグを自動付与
- 失敗時は最大5回までリトライタグ（`🆖`）を付与

---

## 環境変数一覧

| 変数名             | 必須 | 説明                                      |
|--------------------|------|-------------------------------------------|
| CALENDAR_ID        | 必須 | 対象GoogleカレンダーのID                  |
| RUN_AFTER_MINUTES  | 任意 | 終了後何分経過したイベントを対象にするか   |

---

## ライセンス

MIT License
